    # JazzHands | JazzHandsController
# Written by Amber Swarbrick 06/01/2024
# Code Review Passed by Toby Clark 06/01/2024

from gamemaker_handler import GMS2Client
from queue import Queue


class JazzhandsController():
    running: bool                                   # A flag to determine if the program has ended. Facilitates safe termination of threads.
    gamemaker_client: GMS2Client 
    gamemaker_queue: Queue                             # An instance of the client queue. Facilitates sending gesture data to the client object.
    pi_queue: Queue                          # An instance of the gesture_recognition queue. Allows transmission of gesture data to the client.
    

    

    def __init__(self) -> None:
        """
        Main function which initiates the client and gesture recognition.
        """

        self.create_client()

        # Boolean flag to continuously run the controller until a stopping condition is met.
        self.running = True
        
    def create_client(self) -> None:
        """
        Creates a thread which initialises the client.
        """

        self.gamemaker_client = GMS2Client()
        self.gamemaker_queue: Queue = self.gamemaker_client.client_queue
        self.gamemaker_client.start_thread()


    def mainloop(self) -> None:
        """
        Program Main Loop. Retrieves gesture detections and sends them to GameMaker server.
        """
        while self.running:
            self.update_client()
        print("stopped running")

    def update_client(self) -> None:
        """
        Attempt to update the client. Handle keyboard interrupt exceptions.
        """
        try:
            self.try_transmit_to_client()

        # The program will safely end upon a keyboard interrupt (Ctrl+C).
        except KeyboardInterrupt:
            self.terminate_program()
        except Exception as e:
            raise e
    
    def terminate_program(self) -> None:
        """
        Safely end all threads and terminate the main process.
        """
        print("CTRL+C has been pressed. Ending threads.")
        self.pi_client.stop_thread()
        self.gamemaker_client.stop_thread()
        self.running = False
        exit(0)

    def try_transmit_to_client(self) -> bool:
        """
        Attempt to send the most recent gesture from gesture_queue to the GMS2 server.
        """


        self.gamemaker_client.send_response("")



if __name__ == "__main__":
    c = JazzhandsController()
    c.mainloop()